<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bwip-js/4.2.0/bwip-js-min.js"
        integrity="sha512-hGe32CfGdkpO3YQLLNOZiD0+9KXqH+ijWW9ncLze3pO3cUEac1i0CEnuz8DUWCsBisft7V9j9m0rkIo6DMkzAw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.2/jspdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"
        integrity="sha512-CeIsOAsgJnmevfCi2C7Zsyy6bQKi43utIjdA87Q0ZY84oDqnI0uwfM9+bKiIkI75lUeI00WG/+uJzOmuHlesMA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

</head>

<body>

    <div class="container">
        <div class="row gx-3">
            <div class="col-sm-3">
                <div class="p-3 border bg-light">
                    <div class="row">
                        <div class="col-12 flex-row d-flex">
                            <button id="printBatch" class="btn btn-primary square-button" data-bs-toggle="tooltip" title="Vygenerovat pdf">
                                <span class="material-symbols-outlined">
                                    print
                                </span>
                            </button>
                            <button id="importCsv" data-bs-toggle="tooltip" title="Nahrát zdrojové csv" class="btn btn-primary square-button">
                                <span class="material-symbols-outlined">
                                    upload_2
                                </span>
                            </button>
                            <button id="exportSettings" class="btn btn-primary square-button"  data-bs-toggle="modal" data-bs-target="#settingsModal">
                                <span class="material-symbols-outlined">
                                    settings
                                </span>
                            </button>
                        </div>
                    </div>
                    <div class="row py-4 border-bottom">
                        <div class="col-12">
                            <div class="form-group">
                                <span class="h4 d-block">Nastavení papíru</span>
                                <label for="presetPaper">Přednastavené velikosti</label>
                                <select class="form-control" id="presetPaper">
                                    <option value="custom">Vlastní</option>
                                    <option selected=true value="a4">a4</option>
                                    <option value="a3">a3</option>
                                    <option value="a2">a2</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-group">
                                <label for="height">Výška</label>
                                <input type="number" class="form-control" id="height" value=210>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-group">
                                <label for="width">Šířka</label>
                                <input type="number" class="form-control" id="width" value=297>
                            </div>
                        </div>
                    </div>

                    <div class="row  py-4 border-bottom">
                        <div class="col-12">
                            <div class="form-group">
                                <span class="h4 d-block">Nastavení textu</span>
                                <label for="textFont">Font textu</label>
                                <select class="form-control" id="textFont">
                                    <option value="Arial">Arial</option>
                                    <option value="Times New Roman">Times New Roman</option>
                                    <option value="Courier New">Courier New</option>
                                    <option value="Georgia">Georgia</option>
                                    <option value="Verdana">Verdana</option>
                                    <option value="Trebuchet MS">Trebuchet MS</option>
                                    <option value="Comic Sans MS">Comic Sans MS</option>
                                    <option value="Impact">Impact</option>
                                    <option value="Helvetica">Helvetica</option>
                                    <option value="Lucida Grande">Lucida Grande</option>
                                    <option value="Tahoma">Tahoma</option>
                                    <option value="Palatino">Palatino</option>
                                    <option value="Garamond">Garamond</option>
                                    <option value="Bookman Old Style">Bookman Old Style</option>
                                    <option value="Arial Black">Arial Black</option>
                                    <option value="Brush Script MT">Brush Script MT</option>
                                    <option value="Candara">Candara</option>
                                    <option value="Century Gothic">Century Gothic</option>
                                    <option value="Consolas">Consolas</option>
                                    <option value="Calibri">Calibri</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-group">
                                <label for="textKey">Klíč</label>
                                <input type="text" class="form-control" id="textKey" value="text">
                            </div>
                        </div>
                    </div>

                    <div class="row  py-4 border-bottom">
                        <div class="col-12">
                            <div class="form-group">
                                <span class="h4 d-block">Nastavení kódu</span>
                                <label for="qrKind">Druh kódu</label>
                                <select class="form-control" id="qrKind">
                                    <option value="qrcode">QR Code</option>
                                    <option value="datamatrix">Data Matrix</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-group">
                                <label for="qrKey">Klíč</label>
                                <input type="text" class="form-control" id="qrKey" value="code">
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <div class="col-sm-9">
                <div class="p-3 border bg-light"><canvas id="canvas" width="800" height="600"></canvas></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Nastavení</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="btns d-flex justify-content-between w-100">
                    <button type="button" id="settings-import" class="btn btn-primary">Importovat nastavení</button>
                    <button type="button" id="settings-export" class="btn btn-primary ml-auto">Exportovat nastavení</button>
                    <input type="file" name="upload-settings" id="upload-settings" accept="application/JSON" class="d-none">
                </div>
                
            </div>
            </div>
        </div>
    </div>
    <input type="file" id="input-csv-upload" style="display:none" accept=".csv">
</body>

<script>
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })
    const settingsModal = new bootstrap.Modal(document.querySelector("#settingsModal")); 
    const canvas = new fabric.Canvas('canvas', {
        border: "black",
        backgroundColor: "#b8b2b2"
    });
    let paper,codeObject,text, parsedCsvData
    (async () => {
        // canvas

        let isPanning = false;
        let lastPosX = 0;
        let lastPosY = 0;

        paper = new fabric.Rect({
            fill: "white",
            width: fabric.util.parseUnit('290mm'),
            height: fabric.util.parseUnit('210mm'),
            hasBorders: false,
            hasControls: false,
            evented: false,
            selectable: false,
            objectID: "paper"
        });
        canvas.add(paper)


        canvas.on('mouse:down', function (opt) {
            if (opt.e.altKey) {
                var evt = opt.e;
                isPanning = true;
                lastPosX = evt.clientX;
                lastPosY = evt.clientY;
                this.setCursor('grab'); // Change cursor to hand (grab)
                canvas.selection = false; // Disable selection while panning
            }
        });

        canvas.on('mouse:move', function (opt) {
            if (isPanning && opt.e) {
                var e = opt.e;
                var vpt = this.viewportTransform;
                vpt[4] += e.clientX - lastPosX;
                vpt[5] += e.clientY - lastPosY;
                this.requestRenderAll();
                lastPosX = e.clientX;
                lastPosY = e.clientY;
            }
        });

        canvas.on('mouse:up', function (opt) {
            isPanning = false;
            this.setCursor('default'); // Reset cursor
            canvas.selection = true; // Re-enable selection
        });

        canvas.on('mouse:wheel', function (opt) {
            var delta = opt.e.deltaY;
            var zoom = canvas.getZoom();
            zoom *= 0.999 ** delta;
            if (zoom > 2) zoom = 2;
            if (zoom < 0.1) zoom = 0.1;
            canvas.zoomToPoint({ x: opt.e.offsetX, y: opt.e.offsetY }, zoom);
            opt.e.preventDefault();
            opt.e.stopPropagation();
        });

        function getRotatedPoint(x, y, cx, cy, angle) {
            var radians = (Math.PI / 180) * angle,
                cos = Math.cos(radians),
                sin = Math.sin(radians),
                nx = (cos * (x - cx)) - (sin * (y - cy)) + cx,
                ny = (sin * (x - cx)) + (cos * (y - cy)) + cy;
            return { x: nx, y: ny };
        }

        function getRotatedBoundingBox(obj) {
            var angle = obj.angle,
                width = obj.getScaledWidth(),
                height = obj.getScaledHeight(),
                cx = obj.left, // Center X
                cy = obj.top;  // Center Y

            var halfWidth = width / 2,
                halfHeight = height / 2;

            var vertices = [
                getRotatedPoint(cx - halfWidth, cy - halfHeight, cx, cy, angle),
                getRotatedPoint(cx + halfWidth, cy - halfHeight, cx, cy, angle),
                getRotatedPoint(cx - halfWidth, cy + halfHeight, cx, cy, angle),
                getRotatedPoint(cx + halfWidth, cy + halfHeight, cx, cy, angle)
            ];

            return {
                left: Math.min(...vertices.map(v => v.x)),
                top: Math.min(...vertices.map(v => v.y)),
                right: Math.max(...vertices.map(v => v.x)),
                bottom: Math.max(...vertices.map(v => v.y))
            };
        }

        canvas.on("selection:created",function(event){
            var activeSelection = canvas.getActiveObject();

            if(activeSelection && activeSelection.type === 'activeSelection') {
                var originalCenter = activeSelection.getCenterPoint();

                // Set the origin to center
                activeSelection.set({
                    originX: 'center',
                    originY: 'center'
                });

                // Reset the left and top positions based on the original center
                activeSelection.set({
                    left: originalCenter.x,
                    top: originalCenter.y
                });

                // Render the changes on the canvas
                canvas.requestRenderAll();
            }
        })
        
        canvas.on("object:moving", function (obj) {
            const movingBox = obj.target;

            // Get the bounding box considering rotation
            var rotatedBox = getRotatedBoundingBox(movingBox);

            var topBound = paper.top;
            var bottomBound = topBound + paper.height;
            var leftBound = paper.left;
            var rightBound = leftBound + paper.width;

            // Adjust the position of movingBox to keep it within bounds
            if (rotatedBox.left < leftBound) {
                movingBox.left += leftBound - rotatedBox.left;
            }
            if (rotatedBox.top < topBound) {
                movingBox.top += topBound - rotatedBox.top;
            }
            if (rotatedBox.right > rightBound) {
                movingBox.left -= rotatedBox.right - rightBound;
            }
            if (rotatedBox.bottom > bottomBound) {
                movingBox.top -= rotatedBox.bottom - bottomBound;
            }
        });



        // paper

        document.querySelector("#presetPaper").addEventListener("change", (e) => { setPaperDimensions(e) })
        document.querySelector("#width").addEventListener("input", (e) => { setPaperDimensions(e) })
        document.querySelector("#height").addEventListener("input", (e) => { setPaperDimensions(e) })

        const presetPaperDimensions = {
            'a4': { width: 210, height: 297 },
            'a3': { width: 297, height: 420 },
            'a2': { width: 420, height: 594 }
        }
        function setPaperDimensions(e) {
            const dimElem = document.querySelector("#presetPaper")
            const heightElem = document.querySelector("#height")
            const widthElem = document.querySelector("#width")
            switch (e.target) {
                case dimElem:
                    if (e.target.value != "custom") {
                        const paper = presetPaperDimensions[e.target.value]
                        widthElem.value = paper.width
                        heightElem.value = paper.height
                    }
                    break;
                case heightElem:
                case widthElem:
                    dimElem.value = "custom"
                default:
                    break;
            }
            
            paper.set("width", fabric.util.parseUnit(widthElem.value + "mm"))
            paper.set("height", fabric.util.parseUnit(heightElem.value + "mm"))

            canvas.renderAll()
        }

        /* --- TEXT --- */

        text = new fabric.Text("Miele technika s.r.o", {
            fontFamily: "Arial",
            csvKey: "text",
            objectID: "text",
            originX: 'center',
            originY: 'center',
            left: paper.width / 2,
            top: paper.height / 2
        })
        canvas.add(text)

        // font
        document.querySelector("#textFont").addEventListener("change", (e) => { setTextFont(e.target.value) })
        function setTextFont(textFont) {
            text.fontFamily = textFont;
            canvas.renderAll()
        }
        // csv klíč
        document.querySelector("#textKey").addEventListener("change", (e) => {
            text.csvKey = e.target.value || "text"
        })


        /* --- CODE ---*/

        async function generateCode(type, text) {
            const img = document.createElement("img");

            const bwipCanvas = document.createElement("canvas")
            img.src = await bwipjs.toCanvas(bwipCanvas, {
                bcid: type,
                text: text,
                scale: 3,
                includetext: false
            })
            const base64Img = bwipCanvas.toDataURL('image/png');
            return base64Img
        }

        let img = await generateCode("qrcode", "Miele Technika s.r.o")

        async function loadImageAndAddToCanvas(img) {
            return new Promise((resolve, reject) => {
                fabric.Image.fromURL(img, function (qr) {
                    qr.set({
                        originX: 'center',
                        originY: 'center',
                        left: paper.width / 2,
                        top: paper.height / 2 - (qr.height / 2) - text.height
                    });
                    qr.csvKey = "code";
                    qr.objectID = "text"
                    canvas.add(qr);
                    resolve(qr);
                });
            });
        }

        codeObject = await loadImageAndAddToCanvas(img)


        document.querySelector("#qrKind").addEventListener("change", async(e) => {
            img = await generateCode(e.target.value, "teeeest");
            console.log(codeObject)
            codeObject.setSrc(img, function (qr) {
                canvas.renderAll();
                codeObject = qr;
            });
            canvas.renderAll();
        })

        document.querySelector("#qrKey").addEventListener("change", (e) => {
            codeObject.csvKey = e.target.value || "code";
        })


        /* --- CSV --- */
        async function batchFromCsv() {
            if(!parsedCsvData){
                return alert("Nebyl nahrán csv soubor!")
            }
            const pdf = new jsPDF({
                orientation: 'landscape',
                unit: 'px',
                format: [paper.width, paper.height]
            });

            for (let i = 0; i < parsedCsvData.length; i++) {
                if (i > 0) {
                    pdf.addPage();
                }

                const el = parsedCsvData[i];

                if (el[text.csvKey]) {
                    text.text = el[text.csvKey];
                }else{
                    return alert(`Sloupec ${text.csvKey} se nenachází v přiloženém csv!`)
                }

                if (el[codeObject.csvKey]) {
                    const codeText = el[codeObject.csvKey];
                    const codeType = document.querySelector("#qrKind").value;
                    const img = await generateCode(codeType, codeText);
                    console.log(img);
                    await new Promise((resolve) => {
                        codeObject.setSrc(img, function (qr) {
                            resolve();
                        });
                    });
                }else{
                    return alert(`Sloupec ${codeObject.csvKey} se nenachází v přiloženém csv!`)
                }

                await new Promise((resolve) => {
                    canvas.clone(function (clonedCanvas) {
                        const group = new fabric.Group([...clonedCanvas.getObjects()]);
                        console.log(group);
                        const groupDataUrl = group.toDataURL({
                            format: 'jpeg',
                            quality: 0.8,
                        });
                        console.log(groupDataUrl);
                        pdf.addImage(groupDataUrl, 'PNG', 0, 0, paper.width, paper.height);
                        resolve();
                    });
                });
            }

            pdf.save("qr.pdf");
        }

        function parseCsv(csv){
            const lines = csv.trim().split("\n");
            const headers = lines[0].split(";");
            
            const jsonData = [];
            for (let i = 1; i < lines.length; i++) {
                const row = lines[i].split(";");
                const obj = {};
                for (let j = 0; j < headers.length; j++) {
                    obj[headers[j].replace(/\r/g, "").trim()] = row[j].replace(/\r/g, "").trim();
                }
                jsonData.push(obj);
            }
            return jsonData;
        }
        document.querySelector("#printBatch").addEventListener("click", () => {
            batchFromCsv()
        })

        document.querySelector("#importCsv").addEventListener("click",()=>{
            document.querySelector("#input-csv-upload").click();
        })

        document.querySelector("#input-csv-upload").addEventListener("change",(e)=>{
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    parsedCsvData = parseCsv(content);
                };
                reader.readAsText(file);
            }
        })

        /* --- SETTINGS --- */
        function exportSettings(){
            const data = JSON.stringify(canvas.toJSON(['hasBorders', 'hasControls', 'evented', 'selectable', 'objectID', 'originX', 'originY']));

            var blob = new Blob([data], { type: 'application/json' });
            var downloadUrl = URL.createObjectURL(blob);
            var downloadLink = document.createElement('a');
            downloadLink.href = downloadUrl;
            downloadLink.download = 'canvasData.json';

            downloadLink.click();

            URL.revokeObjectURL(downloadUrl);
        }

        function importCanvasSettings(settings){
            if (!settings || !settings.objects || !Array.isArray(settings.objects)) {
                return bs.alert("error","Při nahrávání nastavení došlo k chybě")
            }

            canvas.loadFromJSON(settings,()=>{
                paper = canvas.getObjects().find(o=>o.objectID === 'paper')
                codeObject = canvas.getObjects().find(o=>o.objectID === 'code')
                text = canvas.getObjects().find(o=>o.objectID === 'text')
            })
            
            
        }

        document.querySelector("#settings-export").addEventListener("click", ()=>{
            exportSettings();
        })

        document.querySelector("#settings-import").addEventListener("click", ()=>{
            document.querySelector("#upload-settings").click();
        })

        document.querySelector("#upload-settings").addEventListener("change", (e)=>{
            var file = e.target.files[0];
            if (file) {
                var reader = new FileReader();
                reader.readAsText(file, "UTF-8");
                reader.onload = function(evt) {
                    settingsModal.hide()
                    var fileContent = evt.target.result;
                    try {
                        var settings = JSON.parse(fileContent);
                    } catch (error) {
                        return bs.alert("error","Import nastavení selhal")    
                    }

                    importCanvasSettings(settings);
                }
                reader.onerror = function(evt) {
                    console.error("An error ocurred reading the file", evt);
                };
            }
        })
    })();

    const bs = {
            alert: (type,content,options = {})=>{
                let t
                switch (type) {
                    case "success": 
                        t = "alert-success"
                        break;
                    case "warning": 
                        t = "alert-warning"
                        break;
                    case "error": 
                        t = "alert-danger"
                        break;
                
                    default:
                        throw new Error("Wrong error type")
                        break;
                }

                const div = document.createElement("div")
                div.classList.add(t,"alert","fade","show")
                div.setAttribute("role","alert")
                div.innerHTML = `
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                <div class="alert-content">
                    ${content}
                </div>
                `
                const bsAlert = new bootstrap.Alert(div)

                document.querySelector("body").appendChild(div)
                setTimeout(()=>{
                    bsAlert._element? bsAlert.close() : false
                },options.dismissTime * 1000 || 5000)
            }
        }
</script>

</html>