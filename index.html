<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bwip-js/4.2.0/bwip-js-min.js"
        integrity="sha512-hGe32CfGdkpO3YQLLNOZiD0+9KXqH+ijWW9ncLze3pO3cUEac1i0CEnuz8DUWCsBisft7V9j9m0rkIo6DMkzAw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.2/jspdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"
        integrity="sha512-CeIsOAsgJnmevfCi2C7Zsyy6bQKi43utIjdA87Q0ZY84oDqnI0uwfM9+bKiIkI75lUeI00WG/+uJzOmuHlesMA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

</head>

<body>

    <div class="container">
        <div class="row gx-3">
            <div class="col-sm-3 bg-light border">
                <div class="p-3 border" >
                    <div class="row">
                        <div class="col-12 flex-row d-flex">
                            <button id="printBatch" class="btn btn-primary square-button" data-bs-toggle="tooltip" title="Vygenerovat pdf">
                                <span class="material-symbols-outlined">
                                    print
                                </span>
                            </button>
                            <button id="importCsv" data-bs-toggle="tooltip" title="Nahrát zdrojové csv" class="btn btn-primary square-button">
                                <span class="material-symbols-outlined">
                                    upload_2
                                </span>
                            </button>
                            <button id="exportSettings" class="btn btn-primary square-button"  data-bs-toggle="modal" data-bs-target="#settingsModal">
                                <span class="material-symbols-outlined">
                                    settings
                                </span>
                            </button>
                            <button id="info" class="btn btn-primary square-button"  data-bs-toggle="modal" data-bs-target="#infoModal">
                                <span class="material-symbols-outlined">
                                    help
                                </span>
                            </button>
                            <button id="csvTable" class="btn btn-primary square-button"  data-bs-toggle="modal" data-bs-target="#csvModal">
                                <span class="material-symbols-outlined">
                                    table_view
                                </span>
                            </button>
                        </div>
                    </div>
                    <div class="row py-4 border-bottom">
                        <div class="col-12">
                            <div class="form-group">
                                <span class="h4 d-block">Nastavení papíru</span>
                                <label for="presetPaper">Přednastavené velikosti</label>
                                <select class="form-control" id="presetPaper">
                                    <option value="custom">Vlastní</option>
                                    <option selected=true value="a4">a4</option>
                                    <option value="a3">a3</option>
                                    <option value="a2">a2</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-group">
                                <label for="height">Výška</label>
                                <input type="number" class="form-control" id="height" value=210>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-group">
                                <label for="width">Šířka</label>
                                <input type="number" class="form-control" id="width" value=297>
                            </div>
                        </div>
                    </div>

                    <div class="row  py-4 border-bottom">
                        <div class="col-12">
                            <div class="form-group">
                                <span class="h4 d-block">Nastavení textu</span>
                                <label for="textFont">Font textu</label>
                                <select class="form-control" id="textFont">
                                    <option value="Arial">Arial</option>
                                    <option value="Times New Roman">Times New Roman</option>
                                    <option value="Courier New">Courier New</option>
                                    <option value="Georgia">Georgia</option>
                                    <option value="Verdana">Verdana</option>
                                    <option value="Trebuchet MS">Trebuchet MS</option>
                                    <option value="Comic Sans MS">Comic Sans MS</option>
                                    <option value="Impact">Impact</option>
                                    <option value="Helvetica">Helvetica</option>
                                    <option value="Lucida Grande">Lucida Grande</option>
                                    <option value="Tahoma">Tahoma</option>
                                    <option value="Palatino">Palatino</option>
                                    <option value="Garamond">Garamond</option>
                                    <option value="Bookman Old Style">Bookman Old Style</option>
                                    <option value="Arial Black">Arial Black</option>
                                    <option value="Brush Script MT">Brush Script MT</option>
                                    <option value="Candara">Candara</option>
                                    <option value="Century Gothic">Century Gothic</option>
                                    <option value="Consolas">Consolas</option>
                                    <option value="Calibri">Calibri</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-group">
                                <label for="textKey">Název sloupce (csv)</label>
                                <input type="text" class="form-control" id="textKey" value="text">
                            </div>
                        </div>
                    </div>

                    <div class="row  py-4">
                        <div class="col-12">
                            <div class="form-group">
                                <span class="h4 d-block">Nastavení kódu</span>
                                <label for="qrKind">Druh kódu</label>
                                <select class="form-control" id="qrKind">
                                    <option value="qrcode">QR Code</option>
                                    <option value="datamatrix">Data Matrix</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-group">
                                <label for="qrKey">Název sloupce (csv)</label>
                                <input type="text" class="form-control" id="qrKey" value="code">
                            </div>
                        </div>
                    </div>
                    <div class="static-items" data-row-parent>

                    </div>
                    <div class="col-12">
                        <button class="btn-primary w-100" data-add-static-item>+</button>
                    </div>

                </div>
            </div>
            <div class="col-sm-9">
                <div class="p-3 border bg-light h-100">
                    <div class="canvas-wrapper">
                        <canvas id="canvas"></canvas>
                    </div>    
                </div>
            </div>
        </div>

        <div class="loader-wrapper d-none justify-content-center align-items-center flex-column" id="loader">
            <div class="spinner-border" role="status">
                <span class="sr-only"></span>
            </div>
            <span class="message"></span>
        </div>
    </div>

    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Nastavení</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="btns d-flex justify-content-between w-100">
                    <button type="button" id="settings-import" class="btn btn-primary">Importovat nastavení</button>
                    <button type="button" id="settings-export" class="btn btn-primary ml-auto">Exportovat nastavení</button>
                    <input type="file" name="upload-settings" id="upload-settings" accept="application/JSON" class="d-none">
                </div>
                
            </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="exampleModalLabel">Návod</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h5>1. import zdrojových dat</h6>
                <p>
                    K importu dat slouží...

                </p>
                
            </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="csvModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Zdrojová data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-0" id="csvTableWrapper" style="overflow:auto; max-height:80vh">
                
            </div>
            </div>
        </div>
    </div>
    <input type="file" id="input-csv-upload" style="display:none" accept=".csv">
</body>

<script>
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })
    const settingsModal = new bootstrap.Modal(document.querySelector("#settingsModal"));
    const canvasElem = document.querySelector("#canvas")
    canvasElem.width = document.querySelector(".canvas-wrapper").clientWidth
    canvasElem.height = document.querySelector(".canvas-wrapper").clientHeight
    const canvas = new fabric.Canvas('canvas', {
        border: "black",
        backgroundColor: "#b8b2b2"
    });
    let paper,codeObject,text, parsedCsvData
    let guidelineLines = [];
    (async () => {
        // canvas

        let isPanning = false;
        let lastPosX = 0;
        let lastPosY = 0;

        paper = new fabric.Rect({
            fill: "white",
            width: fabric.util.parseUnit('50mm'),
            height: fabric.util.parseUnit('50mm'),
            hasBorders: false,
            hasControls: false,
            evented: false,
            selectable: false,
            objectID: "paper"
        });
        canvas.add(paper)


        canvas.on('mouse:down', function (opt) {
            if (opt.e.altKey) {
                var evt = opt.e;
                isPanning = true;
                lastPosX = evt.clientX;
                lastPosY = evt.clientY;
                this.setCursor('grab'); // Change cursor to hand (grab)
                canvas.selection = false; // Disable selection while panning
            }
        });

        canvas.on('mouse:move', function (opt) {
            if (isPanning && opt.e) {
                var e = opt.e;
                var vpt = this.viewportTransform;
                vpt[4] += e.clientX - lastPosX;
                vpt[5] += e.clientY - lastPosY;
                this.requestRenderAll();
                lastPosX = e.clientX;
                lastPosY = e.clientY;
            }
        });

        canvas.on('mouse:up', function (opt) {
            isPanning = false;
            this.setCursor('default'); // Reset cursor
            canvas.selection = true; // Re-enable selection
        });

        canvas.on('object:modified', function() {
            removeGuidelines(canvas, guidelineLines);
            guidelineLines = [];
        });

        canvas.on('mouse:wheel', function (opt) {
            var delta = opt.e.deltaY;
            var zoom = canvas.getZoom();
            zoom *= 0.999 ** delta;
            if (zoom > 2) zoom = 2;
            if (zoom < 0.1) zoom = 0.1;
            canvas.zoomToPoint({ x: opt.e.offsetX, y: opt.e.offsetY }, zoom);
            opt.e.preventDefault();
            opt.e.stopPropagation();
        });

        function getRotatedPoint(x, y, cx, cy, angle) {
            var radians = (Math.PI / 180) * angle,
                cos = Math.cos(radians),
                sin = Math.sin(radians),
                nx = (cos * (x - cx)) - (sin * (y - cy)) + cx,
                ny = (sin * (x - cx)) + (cos * (y - cy)) + cy;
            return { x: nx, y: ny };
        }

        function getRotatedBoundingBox(obj) {
            var angle = obj.angle,
                width = obj.getScaledWidth(),
                height = obj.getScaledHeight(),
                cx = obj.left, // Center X
                cy = obj.top;  // Center Y

            var halfWidth = width / 2,
                halfHeight = height / 2;

            var vertices = [
                getRotatedPoint(cx - halfWidth, cy - halfHeight, cx, cy, angle),
                getRotatedPoint(cx + halfWidth, cy - halfHeight, cx, cy, angle),
                getRotatedPoint(cx - halfWidth, cy + halfHeight, cx, cy, angle),
                getRotatedPoint(cx + halfWidth, cy + halfHeight, cx, cy, angle)
            ];

            return {
                left: Math.min(...vertices.map(v => v.x)),
                top: Math.min(...vertices.map(v => v.y)),
                right: Math.max(...vertices.map(v => v.x)),
                bottom: Math.max(...vertices.map(v => v.y))
            };
        }

        canvas.on("selection:created",function(event){
            var activeSelection = canvas.getActiveObject();

            if(activeSelection && activeSelection.type === 'activeSelection') {
                var originalCenter = activeSelection.getCenterPoint();

                // Set the origin to center
                activeSelection.set({
                    originX: 'center',
                    originY: 'center'
                });

                // Reset the left and top positions based on the original center
                activeSelection.set({
                    left: originalCenter.x,
                    top: originalCenter.y
                });

                // Render the changes on the canvas
                canvas.requestRenderAll();
            }
        })
        
        canvas.on("object:moving", function (obj) {
            const movingBox = obj.target;
            if(guidelineLines.length === 0){
                guidelineLines = addGuidelines(canvas)
            }
            
            // Get the bounding box considering rotation
            var rotatedBox = getRotatedBoundingBox(movingBox);

            var topBound = paper.top;
            var bottomBound = topBound + paper.height;
            var leftBound = paper.left;
            var rightBound = leftBound + paper.width;

            // Define the snapping intervals (5% of paper width and height)
            var snapIntervalX = paper.width * 0.01;
            var snapIntervalY = paper.height * 0.01;

            // Adjust the position of movingBox to keep it within bounds
            if (rotatedBox.left < leftBound) {
                movingBox.left += leftBound - rotatedBox.left;
            }
            if (rotatedBox.top < topBound) {
                movingBox.top += topBound - rotatedBox.top;
            }
            if (rotatedBox.right > rightBound) {
                movingBox.left -= rotatedBox.right - rightBound;
            }
            if (rotatedBox.bottom > bottomBound) {
                movingBox.top -= rotatedBox.bottom - bottomBound;
            }

            // Snap to the nearest horizontal interval
            movingBox.left = Math.round(movingBox.left / snapIntervalX) * snapIntervalX;

            // Snap to the nearest vertical interval
            movingBox.top = Math.round(movingBox.top / snapIntervalY) * snapIntervalY;

            // Update the object's position
            movingBox.setCoords();
        });



        // paper

        document.querySelector("#presetPaper").addEventListener("change", (e) => { setPaperDimensions(e) })
        document.querySelector("#width").addEventListener("input", (e) => { setPaperDimensions(e) })
        document.querySelector("#height").addEventListener("input", (e) => { setPaperDimensions(e) })

        const presetPaperDimensions = {
            'a4': { width: 210, height: 297 },
            'a3': { width: 297, height: 420 },
            'a2': { width: 420, height: 594 }
        }
        function setPaperDimensions(e) {
            const dimElem = document.querySelector("#presetPaper")
            const heightElem = document.querySelector("#height")
            const widthElem = document.querySelector("#width")
            switch (e.target) {
                case dimElem:
                    if (e.target.value != "custom") {
                        const paper = presetPaperDimensions[e.target.value]
                        widthElem.value = paper.width
                        heightElem.value = paper.height
                    }
                    break;
                case heightElem:
                case widthElem:
                    dimElem.value = "custom"
                default:
                    break;
            }
            
            paper.set("width", fabric.util.parseUnit(widthElem.value + "mm"))
            paper.set("height", fabric.util.parseUnit(heightElem.value + "mm"))

            canvas.renderAll()
        }

        /* --- TEXT --- */

        text = new fabric.Text("Miele technika s.r.o", {
            fontFamily: "Arial",
            csvKey: "text",
            objectID: "text",
            originX: 'center',
            originY: 'center',
            left: paper.width / 2,
            top: paper.height / 2
        })
        canvas.add(text)

        // font
        document.querySelector("#textFont").addEventListener("change", (e) => { setTextFont(e.target.value) })
        function setTextFont(textFont) {
            text.fontFamily = textFont;
            canvas.renderAll()
        }
        // csv klíč
        document.querySelector("#textKey").addEventListener("change", (e) => {
            text.csvKey = e.target.value.trim() || "text"
        })


        /* --- CODE ---*/

        async function generateCode(type, text) {
            //const img = document.createElement("img");
            const bwipCanvas = document.createElement("canvas")
            let options = {}
            options.bcid = type;
            options.text = text;
            options.scale = 3;
            options.includetext = false;

            // pokud chybí data pro generování kódu, barcode vygeneruji červený, value = 0
            if(!text){
                options.barcolor = "FF0000";
                options.text = "0";
            }

            await bwipjs.toCanvas(bwipCanvas, options)
            const base64Img = bwipCanvas.toDataURL('image/png');
            return base64Img
        }

        let img = await generateCode("qrcode", "Miele Technika s.r.o")

        async function loadImageAndAddToCanvas(img) {
            return new Promise((resolve, reject) => {
                fabric.Image.fromURL(img, function (qr) {
                    qr.set({
                        originX: 'center',
                        originY: 'center',
                        left: paper.width / 2,
                        top: paper.height / 2 - (qr.height / 2) - text.height
                    });
                    qr.csvKey = "code";
                    qr.objectID = "code",
                    qr.codeType = document.querySelector("#qrKind").value
                    canvas.add(qr);
                    resolve(qr);
                });
            });
        }

        codeObject = await loadImageAndAddToCanvas(img)


        document.querySelector("#qrKind").addEventListener("change", async(e) => {
            img = await generateCode(e.target.value, "Miele Technika s.r.o");
            codeObject.setSrc(img, function (qr) {
                canvas.renderAll();
                codeObject = qr;
            });
            codeObject.codeType = e.target.value
            canvas.renderAll();
        })

        document.querySelector("#qrKey").addEventListener("change", (e) => {
            codeObject.csvKey = e.target.value.trim() || "code";
        })


        /* --- CSV --- */
        async function batchFromCsv() {
            // const parsedCsvData = [{"code":"STC Schwab Technologie-Center GMBH"},{"code":"asd"},{"code":"Dopravní značení Svoboda, Olomouc s.r.o."},{"code":"Rybářství a chov drůbeže Horák Zdeněk, s.r.o."}]
            console.log(parsedCsvData)
            if(!parsedCsvData){
                return alert("Nebyl nahrán csv soubor!")
            }

            try{
                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'px',
                    format: [paper.width, paper.height]
                });

                ui.loader.show()
                ui.loader.message("Probíhá generování pdf")
                for (let i = 0; i < parsedCsvData.length; i++) {
                    if (i > 0) {
                        pdf.addPage();
                    }

                    const el = parsedCsvData[i];
                    if (el[text.csvKey]) {
                        text.text = el[text.csvKey];
                    }else{
                        text.text = ""
                    }

                    
                    const codeText = el[codeObject.csvKey] || "";
                    const codeType = document.querySelector("#qrKind").value;
                    const img = await generateCode(codeType, codeText);
                    const originalLeft = codeObject.left;
                    const originalTop = codeObject.top;
                    const originalWidth = codeObject.width * codeObject.scaleX;
                    const originalHeight = codeObject.height * codeObject.scaleY;

                    await new Promise((resolve) => {
                        codeObject.setSrc(img, function () {
                            // Get the natural dimensions of the new image
                            const naturalWidth = codeObject._element.naturalWidth;
                            const naturalHeight = codeObject._element.naturalHeight;

                            // Calculate the scale factors
                            const scaleX = originalWidth / naturalWidth;
                            const scaleY = originalHeight / naturalHeight;

                            // Determine which scale to use to maintain aspect ratio
                            const scale = Math.min(scaleX, scaleY);

                            // Apply the scale
                            codeObject.scaleX = scale;
                            codeObject.scaleY = scale;

                            // Reset the position to its original
                            codeObject.set({
                                left: originalLeft,
                                top: originalTop
                            });

                            // Update the canvas
                            resolve();
                        });
                    });
                    
                    await new Promise((resolve) => {
                        canvas.clone(function (clonedCanvas) {
                            const group = new fabric.Group([...clonedCanvas.getObjects()]);
                            //console.log(group);
                            const groupDataUrl = group.toDataURL({
                                format: 'jpeg',
                                quality: 1,
                            });
                            //console.log(groupDataUrl);
                            pdf.addImage(groupDataUrl, 'PNG', 0, 0, paper.width, paper.height);
                            resolve();
                        });
                    });
                }
                
                ui.loader.hide();
                const now = new Date();
                const ddmmyy = [now.getHours(), now.getMinutes(), now.getSeconds(), now.getDate(), now.getMonth() + 1, now.getFullYear().toString().substr(-2)].map(n => String(n).padStart(2, '0')).join('');

                pdf.save(`${ddmmyy.slice(0, 6)}_${ddmmyy.slice(6)}.pdf`);
                ui.alert("success","Generování pdf proběhlo úspěšně")

            }catch($e){
                ui.loader.hide()
                ui.alert("error","Generování pdf selhalo")
                console.error(error)
            }
        }

        function parseCsv(csv){
            const lines = csv.trim().split("\n");
            const headers = lines[0].split(";");
            
            const jsonData = [];
            for (let i = 1; i < lines.length; i++) {
                const row = lines[i].split(";");
                const obj = {};
                for (let j = 0; j < headers.length; j++) {
                    obj[headers[j].replace(/\r/g, "").trim()] = row[j].replace(/\r/g, "").trim();
                }
                jsonData.push(obj);
            }
            return jsonData;
        }
        document.querySelector("#printBatch").addEventListener("click", () => {
            batchFromCsv()
        })

        document.querySelector("#importCsv").addEventListener("click",()=>{
            document.querySelector("#input-csv-upload").click();
        })

        document.querySelector("#input-csv-upload").addEventListener("change",(e)=>{
            const file = e.target.files[0];
            try{
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const content = e.target.result;
                        parsedCsvData = parseCsv(content);
                        visualizeCsvData()
                    };
                    reader.readAsText(file);
                    ui.alert("success","Načtení csv proběhlo úspěšně")
                }
            }catch($e){
                ui.alert("error","Při načítání csv došlo k chybě");
            }
            
        })

        /* --- SETTINGS --- */
        function exportSettings(){
            const data = JSON.stringify(canvas.toJSON(['hasBorders', 'hasControls', 'evented', 'selectable', 'objectID', 'originX', 'originY','codeType','csvKey', 'objectType', 'staticType']));

            var blob = new Blob([data], { type: 'application/json' });
            var downloadUrl = URL.createObjectURL(blob);
            var downloadLink = document.createElement('a');
            downloadLink.href = downloadUrl;
            downloadLink.download = 'canvasData.json';

            downloadLink.click();

            URL.revokeObjectURL(downloadUrl);
        }

        function importCanvasSettings(settings){
            if (!settings || !settings.objects || !Array.isArray(settings.objects)) {
                return ui.alert("error","Při nahrávání nastavení došlo k chybě")
            }

            canvas.loadFromJSON(settings,()=>{
                paper = canvas.getObjects().find(o=>o.objectID === 'paper')
                codeObject = canvas.getObjects().find(o=>o.objectID === 'code')
                text = canvas.getObjects().find(o=>o.objectID === 'text')
                refreshInputs()

                // static objects
                const staticObjects = canvas.getObjects().filter(o=>o.objectType === 'static')
                staticObjects.forEach(ob=>{
                    new MenuItem(ob);
                })
            })
            
        }

        document.querySelector("#settings-export").addEventListener("click", ()=>{
            exportSettings();
        })

        document.querySelector("#settings-import").addEventListener("click", ()=>{
            document.querySelector("#upload-settings").click();
        })

        document.querySelector("#upload-settings").addEventListener("change", (e)=>{
            var file = e.target.files[0];
            if (file) {
                var reader = new FileReader();
                reader.readAsText(file, "UTF-8");
                reader.onload = function(evt) {
                    settingsModal.hide()
                    var fileContent = evt.target.result;
                    try {
                        var settings = JSON.parse(fileContent);
                    } catch (error) {
                        return ui.alert("error","Import nastavení selhal")    
                    }

                    importCanvasSettings(settings);
                }
                reader.onerror = function(evt) {
                    console.error("An error ocurred reading the file", evt);
                };
            }
        })
    })();

    const ui = {
            alert: (type,content,options = {})=>{
                let t
                switch (type) {
                    case "success": 
                        t = "alert-success"
                        break;
                    case "warning": 
                        t = "alert-warning"
                        break;
                    case "error": 
                        t = "alert-danger"
                        break;
                
                    default:
                        throw new Error("Wrong error type")
                        break;
                }

                const div = document.createElement("div")
                div.classList.add(t,"alert","fade","show")
                div.setAttribute("role","alert")
                div.innerHTML = `
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                <div class="alert-content">
                    ${content}
                </div>
                `
                const bsAlert = new bootstrap.Alert(div)

                document.querySelector("body").appendChild(div)
                setTimeout(()=>{
                    bsAlert._element? bsAlert.close() : false
                },options.dismissTime * 1000 || 5000)
            },
            loader: {
                show:()=>{
                    document.querySelector("#loader").classList.add("d-flex")
                    document.querySelector("#loader").classList.remove("d-none")
                },
                hide:()=>{
                    document.querySelector("#loader").classList.add("d-none")
                    document.querySelector("#loader").classList.remove("d-flex")
                    document.querySelector("#loader .message").innerHTML = ""
                },
                message:(msg)=>{
                    document.querySelector("#loader .message").innerHTML = msg
                }
            }

        }

        function refreshInputs(){
            document.querySelector("#height").value = Math.round(pxToMm(paper.height))
            document.querySelector("#width").value = Math.round(pxToMm(paper.width))

            document.querySelector("#textFont").value = text.fontFamily
            document.querySelector("#textKey").value = text.csvKey

            document.querySelector("#qrKind").value = codeObject.codeType
            document.querySelector("#qrKey").value = codeObject.csvKey

        }

        function pxToMm(pixels, ppi = 96) {
            const inches = pixels / ppi;
            const millimeters = inches * 25.4;
            return millimeters;
        }

        function addGuidelines(canvas) {
            var width = paper.width;
            var height = paper.height;

            var positionsX = [width * 0.25, width * 0.5, width * 0.75];
            var positionsY = [height * 0.25, height * 0.5, height * 0.75];

            var lines = [];

            // Create horizontal lines
            positionsY.forEach(function(posY) {
                var line = new fabric.Line([0, posY, width, posY], {
                    stroke: '#ededed',
                    selectable: false,
                    evented: false
                });
                lines.push(line);
                canvas.add(line);
            });

            // Create vertical lines
            positionsX.forEach(function(posX) {
                var line = new fabric.Line([posX, 0, posX, height], {
                    stroke: '#ededed',
                    selectable: false,
                    evented: false
                });
                lines.push(line);
                canvas.add(line);
            });

            canvas.renderAll();
            return lines;
        }

        function removeGuidelines(canvas, lines) {
            lines.forEach(function(line) {
                canvas.remove(line);
            });
            canvas.renderAll();
        }

        function panToCenter(element) {
            // Calculate the center of the element
            var center = element.getCenterPoint();

            // Calculate the offset needed to center the element
            var offsetX = canvas.getWidth() / 2 - center.x;
            var offsetY = canvas.getHeight() / 2 - center.y;

            // Update the view to center on the element
            canvas.relativePan(new fabric.Point(offsetX, offsetY));
        }
        visualizeCsvData()
        panToCenter(paper)
        function visualizeCsvData(){
            const tWrapper = document.querySelector("#csvTableWrapper");
            
            if(!parsedCsvData){
                return tWrapper.innerHTML = `<h6>Žádná data!</h6>`;
            }
            
            const table = document.createElement("table");
            table.classList.add("table","sticky-header");
            table.dataset.stickyHeader=true
            let uniqueKeys = new Set();

            // Determine unique keys for table headings
            parsedCsvData.forEach(obj => {
                Object.keys(obj).forEach(key => {
                    uniqueKeys.add(key);
                });
            });

            let columns = Array.from(uniqueKeys);

            // Create table heading
            let thead = document.createElement("thead");
            let tRow = document.createElement("tr");
            columns.forEach(e => {
                let th = document.createElement("th");
                th.innerHTML = e;
                tRow.appendChild(th);
            });
            thead.appendChild(tRow);
            table.appendChild(thead);

            // Create table body
            let tbody = document.createElement("tbody");
            parsedCsvData.forEach(row => {
                const tRow = document.createElement("tr");
                columns.forEach(column => {
                    const td = document.createElement("td");
                    td.innerHTML = row[column] || '';
                    tRow.appendChild(td);
                });
                tbody.appendChild(tRow);
            });
            table.appendChild(tbody);

            tWrapper.innerHTML = "";
            tWrapper.appendChild(table);
        }
    
    

    class CanvasElem{
        
        constructor(id){
            this.id = id || this._genId();
            this.canvas = canvas;      
        }

        setCsvKey(key){
            this.csvKey = key
            return this
        }

        getCsvKey(){
            return this.csvKey;
        }

        getId(){
            return this.id;
        }

        setId(id){
            this.id = id;
            return this
        }

        dispose(){
            if(this.fabricItem){
                canvas.remove(this.fabricItem);
            }
        }

        _genId(){
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9)
        }

    }

    class MenuItem{

        constructor(obj = null){
            this.types = [
                {name:"Text",val:"static-text",class:CanvasText,handler:this._handleTextOption},
                {name:"Obrázek",val:"static-img",class:CanvasImage,handler:this._handleImageOption}
            ]
            this._init()
            this._populateType()

            if(obj){
                const foundType = this.types.find((type)=>{return type.val == obj.staticType})
                this.canvasElem = new foundType.class(obj.src,obj.objectID)
                console.log(canvasElem)
            }
        }
        
        _init(){
            this.parentElem = document.createElement("div")
            this.parentElem.classList.add("row","py-4")

            // heading
            const headingParent = document.createElement("div")
            headingParent.classList.add("col-12")
            this.heading = document.createElement("span")
            this.heading.classList.add("h4","d-block")
            headingParent.appendChild(this.heading)

            this.parentElem.appendChild(headingParent)
            this.setHeading("Vlastní element")

            // custom elem type

            const typeRow = document.createElement("div")
            typeRow.classList.add("col-12")
            typeRow.innerHTML= `
                <div class="form-group">
                    <label for="elemType">Typ</label>    
                </div>
            `
            this.typeSelect = document.createElement("select")
            this.typeSelect.classList.add("form-control")

            typeRow.querySelector(".form-group").appendChild(this.typeSelect)

            
            document.querySelector("[data-row-parent]").appendChild(this.parentElem)
            this.parentElem.appendChild(typeRow)
        }

        setHeading(val){
            this.heading.innerHTML = val
        }

        _populateType(){
            this.typeSelect.innerHTML=`
                <option value="" disabled selected>Vyberte</option>
            `
            this.types.forEach(type=>{
                console.log(type)
                const opt = document.createElement("option")
                opt.value = type.val
                opt.innerHTML = type.name
                this.typeSelect.appendChild(opt)
            })
            this.typeSelect.addEventListener("change",(e)=>{
                this._typeListener(e)
            })
        }

        _typeListener(e){
            const val = e.target.value;
            const foundType = this.types.find(t=>t.val == val)
            // remove old handler from ui if exists
            this.handlerElem?.remove()
            foundType?.handler()
        }

        _handleTextOption = () => {
            const div = document.createElement("div")
            div.dataset.handlerElem=""
            div.classList.add("col-12")
            this.handlerElem = div;
            div.innerHTML = `
            <div class="form-group">
                <label>Statický text</label>
                <input type="text" class="form-control" data-text-value value="text">
            </div>
            
            `
            const valInput = div.querySelector("[data-text-value]")
            const generateBtn = document.createElement("button")
            generateBtn.innerText = "Vygenerovat"
            generateBtn.addEventListener("click",()=>{
                
                if(this.canvasElem && (this.canvasElem.fabricItem.objectType !== this.typeSelect.value)){
                    console.log("New type, disposing old")
                    this.canvasElem.dispose()
                    this.canvasElem = null;
                }
                if(!this.canvasElem){
                    this.canvasElem = new CanvasText()
                    this.canvasElem.setValue(valInput.value)
                }else{
                    this.canvasElem.setValue(valInput.value)
                }
                
            })

            const removeButton = document.createElement("button")
            removeButton.innerText = "Odstranit" 
            removeButton.addEventListener("click",()=>{
                if(this.canvasElem){
                    this.canvasElem.dispose()
                }
                this.parentElem.remove();
                
            })
            div.appendChild(generateBtn)
            div.appendChild(removeButton)
            this.parentElem.appendChild(div)
        }

        _handleImageOption = () => {
            const div = document.createElement("div")
            div.dataset.handlerElem=""
            div.classList.add("col-12")
            this.handlerElem = div;
            div.innerHTML = `
            <div class="form-group">
                <label>Statický obrázek</label>
                <input type="file" accept="image/png, image/jpeg" class="form-control" data-image>
            </div>
            
            `
            div.querySelector("[data-image]").addEventListener('change', (e) => {
                var file = e.target.files[0];
                var reader = new FileReader();

                reader.onloadend = () => {
                    this.img = reader.result
                }

                reader.readAsDataURL(file);
            });

            const generateBtn = document.createElement("button")
            
            generateBtn.innerText = "Vygenerovat"

            generateBtn.addEventListener("click",()=>{
                if(!this.img){
                    return
                }

                if(this.canvasElem && (this.canvasElem.fabricItem.objectType !== this.typeSelect.value)){
                    console.log("New type, disposing old")
                    this.canvasElem.dispose()
                    this.canvasElem = null;
                }
                
                if(!this.canvasElem){
                    this.canvasElem = new CanvasImage(this.img)
                }else{
                    this.canvasElem.setValue(this.img)
                }
                
            })

            const removeButton = document.createElement("button")
            removeButton.innerText = "Odstranit"
            removeButton.addEventListener("click",()=>{
                console.log("dispose!", this.canvasElem)
                if(this.canvasElem){
                    this.canvasElem.dispose()
                }
                this.parentElem.remove();
                
            })
            div.appendChild(generateBtn)
            div.appendChild(removeButton)
            
            this.parentElem.appendChild(div)
        }


    }
    
    class CanvasText extends CanvasElem{
        constructor(id){
            super(id);
            this.createFabricItem()
        }

        setValue = (value)=>{
            this.fabricItem.set("text",value)
            this.value = value;
            canvas.renderAll()
        }

        setFont = (font) => {
            this.fabricItem.set("font",font)
            this.font = font
            canvas.renderAll()
        }

        createFabricItem(){
            const id = this.id;
            this.fabricItem = new fabric.Text(this.value || "", {
                fontFamily: this.font || "Arial",
                objectID:id,
                originX: 'center',
                originY: 'center',
                left: paper.width / 2,
                top: paper.height / 2,
                objectType: "static",
                staticType: "static-text"
            })
            canvas.add(this.fabricItem);

            canvas.renderAll()
        }

    }

    class CanvasImage extends CanvasElem{
        constructor(value=null,id){
            super(id);
            this.value = value
            this.createFabricItem()
        }

        setValue = (value)=>{
            this.value = value;
            this.fabricItem.setSrc(this.value, () => {
                canvas.renderAll();
            });
        }

        getValue = ()=>{
            return this.value
        }

        createFabricItem(){
            const id = this.id;
            const foundItem = canvas.getObjects().find((obj)=>obj.objectID === id)
            if(foundItem){
                return this.fabricItem = foundItem
            }

            new fabric.Image.fromURL(this.getValue(), (img) => {
                img.set({
                    originX: 'center',
                    originY: 'center',
                    left: paper.width / 2,
                    top: paper.height / 2
                });
                img.objectID = id;
                img.objectType = "static";
                img.staticType = "static-img";
                this.fabricItem = img;
                canvas.add(img);
                canvas.renderAll()
            });
        }

    }

    document.querySelector("[data-add-static-item]").addEventListener("click",()=>{
        new MenuItem()
    })
</script>

</html>